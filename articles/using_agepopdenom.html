<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Using AgePopDenom • AgePopDenom</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Using AgePopDenom">
<link rel="icon" type="image/png" href="man/figures/logo.png">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">AgePopDenom</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.6.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html">Get started</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/using_agepopdenom.html">Using AgePopDenom</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/truenomad/AgePopDenom" aria-label="GitHub repository"><span class="fa fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Using AgePopDenom</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/truenomad/AgePopDenom/blob/master/vignettes/using_agepopdenom.Rmd" class="external-link"><code>vignettes/using_agepopdenom.Rmd</code></a></small>
      <div class="d-none name"><code>using_agepopdenom.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p><strong>AgePopDenom</strong> is an R package designed for
geostatistical modeling of fine-scale population age structures. By
combining nationally representative survey data (e.g., DHS), geospatial
rasters (e.g., population density), and administrative shapefiles, it
produces single-year age distributions at a high spatial resolution.
This vignette walks you through installing <strong>AgePopDenom</strong>,
setting up a project directory, running the modeling workflow, and
creating outputs such as predictive rasters and age pyramids.</p>
<p>A key advantage of <strong>AgePopDenom</strong> is its simplicity.
The <code><a href="../reference/init.html">init()</a></code> and <code><a href="../reference/run_full_workflow.html">run_full_workflow()</a></code> functions
handle everything from data retrieval to model fitting and result
generation, making it much easier to produce fine-scale demographic maps
for public health and development applications. Whether you need to
incorporate custom covariates or use your own population rasters, the
package is flexible and supports a wide range of user inputs.</p>
<hr>
</div>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<div class="section level3">
<h3 id="system-requirements">System Requirements<a class="anchor" aria-label="anchor" href="#system-requirements"></a>
</h3>
<p>Before installing <strong>AgePopDenom</strong>, ensure your system
meets the following requirements:</p>
<ol style="list-style-type: decimal">
<li>
<strong>R version</strong>: &gt;= 4.1.0</li>
<li>
<strong>C++ compiler</strong>: C++17 compatible</li>
<li>
<strong>TMB</strong> (Template Model Builder)</li>
</ol>
<div class="section level4">
<h4 id="platform-specific-setup">Platform-Specific Setup<a class="anchor" aria-label="anchor" href="#platform-specific-setup"></a>
</h4>
<div class="section level5">
<h5 id="windows">Windows<a class="anchor" aria-label="anchor" href="#windows"></a>
</h5>
<ol style="list-style-type: decimal">
<li>Install Rtools (matches your R version):</li>
</ol>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Check if Rtools is installed and properly configured</span></span>
<span><span class="fu">pkgbuild</span><span class="fu">::</span><span class="fu"><a href="https://pkgbuild.r-lib.org/reference/has_build_tools.html" class="external-link">has_build_tools</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>If FALSE, download and install Rtools from: <a href="https://cran.r-project.org/bin/windows/Rtools/" class="external-link">CRAN
Rtools</a></p>
<p><strong>macOS</strong></p>
<ol style="list-style-type: decimal">
<li>Install Command Line Tools:</li>
</ol>
<pre><code><span><span class="va">xcode</span><span class="op">-</span><span class="va">select</span> <span class="op">-</span><span class="op">-</span><span class="va">install</span></span></code></pre>
<ol start="2" style="list-style-type: decimal">
<li>Alternatively, install gcc via Homebrew:</li>
</ol>
<pre><code>brew install gcc</code></pre>
<p><strong>Linux (Ubuntu/Debian)</strong></p>
<ol style="list-style-type: decimal">
<li>Update your system and install necessary packages:</li>
</ol>
<pre><code>sudo apt-get update
sudo apt-get install build-essential libxml2-dev</code></pre>
</div>
</div>
</div>
<div class="section level3">
<h3 id="agepopdenom-installation">AgePopDenom installation<a class="anchor" aria-label="anchor" href="#agepopdenom-installation"></a>
</h3>
<p>Once the setup is complete, follow the instructions below to download
<strong>AgePopDenom</strong></p>
<p>Note: <strong>AgePopDenom</strong> is currently under development.
Once it is available on CRAN, you will be able to install it using the
following command:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># install.packages("AgePopDenom")</span></span></code></pre></div>
<p>To get the development version from GitHub, use:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># install.packages("devtools")</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"truenomad/AgePopDenom"</span><span class="op">)</span></span></code></pre></div>
<p>Then load it in R:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://truenomad.github.io/AgePopDenom/">AgePopDenom</a></span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="workflow-overview">Workflow Overview<a class="anchor" aria-label="anchor" href="#workflow-overview"></a>
</h2>
<p>AgePopDenom provides a streamlined workflow to generate age-specific
population estimates at a 5 km x 5 km resolution (by default). The main
steps are: 1. Initialize a project 2. Obtain and organize data (survey
data, population rasters, shapefiles) 3. Run the geostatistical model 4.
Generate spatial predictions 5. Export and visualize results. Below is a
typical usage pipeline.</p>
<div class="section level3">
<h3 id="initialize-a-project">1. Initialize a Project<a class="anchor" aria-label="anchor" href="#initialize-a-project"></a>
</h3>
<p>Before starting, ensure you have an <strong>RStudio project</strong>
set up. This will help organize your analysis and outputs into a single,
self-contained directory. An RStudio project is essential for
maintaining reproducibility and keeping your workflow organized.</p>
<p>Once the RStudio project is created, initialize the project folder
structure and create the key scripts by running:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/init.html">init</a></span><span class="op">(</span></span>
<span>  r_script_name <span class="op">=</span> <span class="st">"full_pipeline.R"</span>,</span>
<span>  cpp_script_name <span class="op">=</span> <span class="st">"model.cpp"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The <code><a href="../reference/init.html">init()</a></code> function sets up your project’s directory
structure and creates necessary script templates. When executed, it
creates a standardized folder hierarchy that organizes your data,
scripts, and outputs. The function accepts several parameters to
customize your setup:</p>
<ul>
<li>
<code>r_script_name</code>: Names your main R script (defaults to
“full_pipeline.R”)</li>
<li>
<code>cpp_script_name</code>: Names your C++ model script (defaults
to “model.cpp”)</li>
<li>
<code>open_r_script</code>: Controls whether the R script opens
automatically after creation</li>
<li>
<code>setup_rscript</code>: Determines if the R script should
include template code</li>
</ul>
<p>The resulting directory structure includes:</p>
<pre><code>01_data/
  1a_survey_data/
    processed/
    raw/
  1b_rasters/
    urban_extent/
    pop_raster/
  1c_shapefiles/
02_scripts/
03_outputs/
  3a_model_outputs/
  3b_visualizations/
  3c_table_outputs/
  3d_compiled_results/</code></pre>
<p>and two scripts:</p>
<ul>
<li><p><strong>full_pipeline.R</strong> (orchestrates the entire
analysis)</p></li>
<li><p><strong>model.cpp</strong> (C++ model for fast
optimization)</p></li>
</ul>
</div>
<div class="section level3">
<h3 id="gather-data">2. Gather data<a class="anchor" aria-label="anchor" href="#gather-data"></a>
</h3>
<p>You can download or place your own survey data into
<code>01_data/1a_survey_data/processed/</code>. The survey data should
contain at least:</p>
<ul>
<li>
<em>lat</em>, <em>lon</em> for location</li>
<li>
<em>age_in_years</em> for each individual</li>
<li>An <em>urban</em> indicator (if available)</li>
</ul>
<p>To download DHS data, do:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/download_dhs_datasets.html">download_dhs_datasets</a></span><span class="op">(</span></span>
<span>  country_codes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"GMB"</span><span class="op">)</span>,</span>
<span>  email <span class="op">=</span> <span class="st">"my_email@example.com"</span>,</span>
<span>  project <span class="op">=</span> <span class="st">"Population project"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/process_dhs_data.html">process_dhs_data</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Next, retrieve shapefiles (e.g., WHO boundaries):</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/download_shapefile.html">download_shapefile</a></span><span class="op">(</span><span class="st">"GMB"</span><span class="op">)</span></span></code></pre></div>
<p>Obtain population rasters (e.g., WorldPop):</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/download_pop_rasters.html">download_pop_rasters</a></span><span class="op">(</span><span class="st">"GMB"</span><span class="op">)</span></span></code></pre></div>
<p>Extract urban extent (included with <strong>AgePopDenom</strong> or
supply your own):</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/extract_afurextent.html">extract_afurextent</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="run-the-full-workflow">3. Run the Full Workflow<a class="anchor" aria-label="anchor" href="#run-the-full-workflow"></a>
</h3>
<p>Use <code><a href="../reference/run_full_workflow.html">run_full_workflow()</a></code> to fit the spatial model,
predict gamma parameters, and generate aggregated outputs:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/run_full_workflow.html">run_full_workflow</a></span><span class="op">(</span><span class="st">"GMB"</span><span class="op">)</span></span></code></pre></div>
<p>When you call <code>run_full_workflow("country_code")</code>,
<strong>AgePopDenom</strong> executes the following sub-functions in
sequence:</p>
<div class="section level4">
<h4 id="i--fit_spatial_model">3i. <code>fit_spatial_model()</code><a class="anchor" aria-label="anchor" href="#i--fit_spatial_model"></a>
</h4>
<p><code><a href="../reference/fit_spatial_model.html">fit_spatial_model()</a></code> fits a parameter-based
geostatistical model using Template Model Builder (C++). It reads survey
data, then estimates the Gamma shape (α) and scale (λ) parameters at
each cluster, accounting for spatial correlation via a distance
matrix.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/fit_spatial_model.html">fit_spatial_model</a></span><span class="op">(</span></span>
<span>  <span class="va">country_code</span>,</span>
<span>  <span class="va">data</span>,</span>
<span>  scale_outcome <span class="op">=</span> <span class="st">"log_scale"</span>,</span>
<span>  shape_outcome <span class="op">=</span> <span class="st">"log_shape"</span>,</span>
<span>  covariates <span class="op">=</span> <span class="st">"urban"</span>,</span>
<span>  cpp_script_name <span class="op">=</span> <span class="st">"02_scripts/model"</span>,</span>
<span>  output_dir <span class="op">=</span> <span class="st">"03_outputs/3a_model_outputs"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>This function fits a parameter-based geostatistical model using
Template Model Builder (TMB). Parameters:</p>
<ul>
<li>
<code>country_code</code>: ISO3 country code (e.g., “GMB”)</li>
<li>
<code>data</code>: Survey data frame containing:</li>
<li>
<code>lat</code>, <code>lon</code>: Geographic coordinates</li>
<li>
<code>age_in_years</code>: Individual ages</li>
<li>
<code>urban</code>: Urban/rural indicator (0/1)</li>
<li>
<code>scale_outcome</code>: Column name for log scale parameter</li>
<li>
<code>shape_outcome</code>: Column name for log shape parameter</li>
<li>
<code>covariates</code>: Vector of covariate names</li>
<li>
<code>cpp_script_name</code>: Path to TMB C++ script</li>
<li>
<code>output_dir</code>: Directory for model outputs</li>
<li>
<code>manual_params</code>: Optional list of manual parameter
values:</li>
<li>
<code>beta1</code>: Vector of coefficients for scale model</li>
<li>
<code>beta2</code>: Vector of coefficients for shape model</li>
<li>
<code>gamma</code>: Spatial correlation parameter</li>
<li>
<code>log_sigma2</code>: Log of spatial variance</li>
<li>
<code>log_phi</code>: Log of spatial range parameter</li>
<li>
<code>log_tau2_1</code>: Log of nugget variance</li>
<li>
<code>control_params</code>: Optional list of optimization control
parameters:</li>
<li>
<code>trace</code>: Level of output (0-6)</li>
<li>
<code>maxit</code>: Maximum iterations</li>
<li>
<code>abs.tol</code>: Absolute convergence tolerance</li>
</ul>
<p>The function returns a list containing:</p>
<p>- <code>par</code>: Named vector of fitted parameters</p>
<p>- <code>objective</code>: Final objective function value</p>
<p>- <code>convergence</code>: Convergence status (0 = success)</p>
<p>- <code>scale_formula</code>, <code>shape_formula</code>: Model
formulas</p>
<p>- <code>variogram</code>: Fitted variogram object (if applicable)</p>
<p>The <code>manual_params</code> input in the
<code><a href="../reference/fit_spatial_model.html">fit_spatial_model()</a></code> function allows users to provide their
own initial parameter estimates, offering greater control over the model
optimization process. This is especially useful when default estimates
from the linear regression or variogram fitting might not suit specific
use cases or when prior knowledge of the data suggests alternative
starting values.</p>
<p>When using <code>manual_params</code>, the user must supply a list
containing the following required parameters:</p>
<ul>
<li><p><code>beta1</code>: Coefficients for the scale parameter linear
model</p></li>
<li><p><code>beta2</code>: Coefficients for the shape parameter linear
model</p></li>
<li><p><code>gamma</code>: Coefficient regulating the relationship
between the shape and scale parameters</p></li>
<li><p><code>log_sigma2</code>: Log-transformed variance of the Gaussian
process</p></li>
<li><p><code>log_phi</code>: Log-transformed spatial range parameter,
derived from variogram fitting or user input</p></li>
<li><p><code>log_tau2_1</code>: Log-transformed nugget effect for the
Gaussian process</p></li>
</ul>
<p>If <code>manual_params</code> is not provided, the function derives
these values using default methods, including linear regression for
beta1 and beta2 and an empirical variogram for log_phi. However, when
<code>manual_params</code> is supplied, it overrides these defaults,
enabling advanced users to refine model initialization or replicate
earlier analyses with exact parameter values.</p>
<p>The parameters serve different modeling purposes:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Fixed Effects Parameters</strong> (<code>beta1</code>,
<code>beta2</code>):</li>
</ol>
<ul>
<li>Control the relationship between covariates and the gamma
distribution parameters</li>
<li>Length must match the number of covariates</li>
<li>Typically estimated from initial linear models</li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li>
<strong>Spatial Parameters</strong> (<code>log_sigma2</code>,
<code>log_phi</code>):</li>
</ol>
<ul>
<li>Control the spatial correlation structure</li>
<li>
<code>log_sigma2</code>: Determines strength of spatial effects</li>
<li>
<code>log_phi</code>: Controls the effective range of spatial
correlation</li>
</ul>
<ol start="3" style="list-style-type: decimal">
<li>
<strong>Error and Correlation Parameters</strong>
(<code>gamma</code>, <code>log_tau2_1</code>):</li>
</ol>
<ul>
<li>
<code>gamma</code>: Links shape and scale parameters</li>
<li>
<code>log_tau2_1</code>: Accounts for measurement uncertainty</li>
</ul>
<p>When specifying manual parameters, consider: - Parameter scales (some
are log-transformed) - Relationship to your data’s spatial structure -
Computational stability (avoid extreme values) - Previous successful
model fits</p>
<p>The <code>control_params</code> can be adjusted alongside
<code>manual_params</code> to fine-tune the optimization process:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">control_params</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  trace <span class="op">=</span> <span class="fl">3</span>,        <span class="co"># Higher values show more optimization details</span></span>
<span>  maxit <span class="op">=</span> <span class="fl">2000</span>,     <span class="co"># Increase for complex spatial structures</span></span>
<span>  abs.tol <span class="op">=</span> <span class="fl">1e-10</span>,  <span class="co"># Stricter convergence criteria</span></span>
<span>  rel.tol <span class="op">=</span> <span class="fl">1e-8</span>    <span class="co"># Relative convergence tolerance</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Here’s the technical implementation:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/fit_spatial_model.html">fit_spatial_model</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">survey_data</span>,</span>
<span>  scale_outcome <span class="op">=</span> <span class="st">"log_scale"</span>,</span>
<span>  shape_outcome <span class="op">=</span> <span class="st">"log_shape"</span>,</span>
<span>  covariates <span class="op">=</span> <span class="st">"urban"</span>,</span>
<span>  cpp_script_name <span class="op">=</span> <span class="st">"02_scripts/model"</span>,</span>
<span>  manual_params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    beta1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="op">-</span><span class="fl">0.3</span><span class="op">)</span>,</span>
<span>    beta2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">0.1</span><span class="op">)</span>,</span>
<span>    gamma <span class="op">=</span> <span class="fl">0.8</span>,</span>
<span>    log_sigma2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">0.5</span><span class="op">)</span>,</span>
<span>    log_phi <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>,</span>
<span>    log_tau2_1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">0.1</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  control_params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    trace <span class="op">=</span> <span class="fl">3</span>,</span>
<span>    maxit <span class="op">=</span> <span class="fl">2000</span>,</span>
<span>    abs.tol <span class="op">=</span> <span class="fl">1e-10</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="ii--generate_variogram_plot">3ii. <code>generate_variogram_plot()</code><a class="anchor" aria-label="anchor" href="#ii--generate_variogram_plot"></a>
</h4>
<p>This function creates empirical and fitted variograms to assess
spatial correlation structure in the data. It visualizes how similarity
(in terms of age) between the different cluster locations changes with
distance.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/generate_variogram_plot.html">generate_variogram_plot</a></span><span class="op">(</span></span>
<span>  <span class="va">age_param_data</span>,</span>
<span>  <span class="va">fit_vario</span>,</span>
<span>  <span class="va">country_code</span>,</span>
<span>  scale_outcome <span class="op">=</span> <span class="st">"log_scale"</span>,</span>
<span>  output_dir <span class="op">=</span> <span class="st">"03_outputs/3b_visualizations"</span>,</span>
<span>  width <span class="op">=</span> <span class="fl">12</span>,</span>
<span>  height <span class="op">=</span> <span class="fl">9</span>,</span>
<span>  png_resolution <span class="op">=</span> <span class="fl">300</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Parameters:</p>
<ul>
<li>
<code>age_param_data</code>: Data frame containing survey locations
and parameters</li>
<li>
<code>fit_vario</code>: Fitted variogram object from spatial
model</li>
<li>
<code>country_code</code>: ISO3 country code</li>
<li>
<code>scale_outcome</code>: Column name for outcome variable
(“log_scale” or “log_shape”)</li>
<li>
<code>output_dir</code>: Directory for saving plots</li>
<li>
<code>width</code>, <code>height</code>: Plot dimensions in
inches</li>
<li>
<code>png_resolution</code>: Resolution of saved PNG file in
DPI</li>
</ul>
<p>The function: - Computes empirical variogram from data points -
Overlays fitted theoretical variogram - Creates diagnostic plot showing
spatial correlation decay - Saves plot as PNG file in specified output
directory</p>
<p>Returns: - ggplot2 object of variogram plot - Saved PNG file in
output directory</p>
</div>
<div class="section level4">
<h4 id="iii--create_prediction_data">3iii. <code>create_prediction_data()</code><a class="anchor" aria-label="anchor" href="#iii--create_prediction_data"></a>
</h4>
<p>This function builds a gridded dataset at ~5 km resolution, merging
population rasters, urban-rural classification, and admin boundaries.
Ensures each cell is linked to the proper covariates.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/create_prediction_data.html">create_prediction_data</a></span><span class="op">(</span></span>
<span>  <span class="va">country_code</span>,</span>
<span>  <span class="va">country_shape</span>,</span>
<span>  <span class="va">pop_raster</span>,</span>
<span>  <span class="va">ur_raster</span>,</span>
<span>  <span class="va">adm2_shape</span>,</span>
<span>  cell_size <span class="op">=</span> <span class="fl">5000</span>,</span>
<span>  ignore_cache <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  output_dir <span class="op">=</span> <span class="st">"03_outputs/3a_model_outputs"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Creates a regular grid for predictions. Parameters:</p>
<ul>
<li>
<code>country_code</code>: ISO3 country code</li>
<li>
<code>country_shape</code>: sf object of country boundary</li>
<li>
<code>pop_raster</code>: Population density raster</li>
<li>
<code>ur_raster</code>: Urban/rural classification raster</li>
<li>
<code>adm2_shape</code>: Administrative boundaries (sf object)</li>
<li>
<code>cell_size</code>: Grid resolution in meters</li>
<li>
<code>ignore_cache</code>: Whether to regenerate existing grids</li>
<li>
<code>output_dir</code>: Output directory for grid data</li>
</ul>
<p>The grid includes: - Centroid coordinates - Population values -
Urban/rural classification - Administrative unit IDs</p>
</div>
<div class="section level4">
<h4 id="iv-generate_gamma_predictions">3iv <code>generate_gamma_predictions()</code><a class="anchor" aria-label="anchor" href="#iv-generate_gamma_predictions"></a>
</h4>
<p>This function uses the fitted model parameters to simulate Gamma
distributions at unobserved locations. Produces shape and scale
estimates plus uncertainties.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/generate_gamma_predictions.html">generate_gamma_predictions</a></span><span class="op">(</span></span>
<span>  <span class="va">country_code</span>,</span>
<span>  <span class="va">age_param_data</span>,</span>
<span>  <span class="va">model_params</span>,</span>
<span>  <span class="va">predictor_data</span>,</span>
<span>  <span class="va">shapefile</span>,</span>
<span>  cell_size <span class="op">=</span> <span class="fl">5000</span>,</span>
<span>  n_sim <span class="op">=</span> <span class="fl">5000</span>,</span>
<span>  ignore_cache <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  output_dir <span class="op">=</span> <span class="st">"03_outputs/3a_model_outputs"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Parameters:</p>
<ul>
<li><p><code>country_code</code>: ISO3 country code</p></li>
<li><p><code>age_param_data</code>: Fitted parameters at survey
locations</p></li>
<li><p><code>model_params</code>: List of model parameters from
fit_spatial_model()</p></li>
<li><p><code>predictor_data</code>: Grid cells for prediction</p></li>
<li><p><code>shapefile</code>: Administrative boundaries</p></li>
<li><p><code>cell_size</code>: Grid resolution</p></li>
<li><p><code>n_sim</code>: Number of Monte Carlo simulations</p></li>
<li><p><code>ignore_cache</code>: Whether to use cached
predictions</p></li>
<li><p><code>output_dir</code>: Output directory</p></li>
</ul>
<p>Returns:</p>
<ul>
<li>Predicted shape and scale parameters</li>
</ul>
</div>
<div class="section level4">
<h4 id="v--generate_gamma_raster_plot">3v. <code>generate_gamma_raster_plot()</code><a class="anchor" aria-label="anchor" href="#v--generate_gamma_raster_plot"></a>
</h4>
<p>This function converts shape, scale, and derived mean-age predictions
into rasters. Creates exploratory maps for validation or visual
inspection.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/generate_gamma_raster_plot.html">generate_gamma_raster_plot</a></span><span class="op">(</span></span>
<span>  <span class="va">predictor_data</span>,</span>
<span>  <span class="va">pred_list</span>,</span>
<span>  <span class="va">country_code</span>,</span>
<span>  output_dir <span class="op">=</span> <span class="st">"03_outputs/3b_visualizations"</span>,</span>
<span>  save_raster <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Parameters:</p>
<ul>
<li><p><code>predictor_data</code>: Grid cell data</p></li>
<li><p><code>pred_list</code>: Prediction results</p></li>
<li><p><code>country_code</code>: ISO3 country code</p></li>
<li><p><code>output_dir</code>: Output directory</p></li>
<li><p><code>save_raster</code>: Whether to save raster files</p></li>
</ul>
<p>Produces:</p>
<ul>
<li><p>Shape parameter raster</p></li>
<li><p>Scale parameter raster</p></li>
<li><p>Mean age raster</p></li>
</ul>
</div>
<div class="section level4">
<h4 id="vi--generate_age_pop_table">3vi. <code>generate_age_pop_table()</code><a class="anchor" aria-label="anchor" href="#vi--generate_age_pop_table"></a>
</h4>
<p>This function computes age-specific population counts by applying
Gamma-based proportions to population rasters. Aggregates counts and
proportions at selected administrative levels (e.g., district,
region).</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/generate_age_pop_table.html">generate_age_pop_table</a></span><span class="op">(</span></span>
<span>  <span class="va">predictor_data</span>,</span>
<span>  <span class="va">scale_pred</span>,</span>
<span>  <span class="va">shape_pred</span>,</span>
<span>  <span class="va">country_code</span>,</span>
<span>  age_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">99</span><span class="op">)</span>,</span>
<span>  age_interval <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  ignore_cache <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  output_dir <span class="op">=</span> <span class="st">"03_outputs/3c_table_outputs"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Parameters:</p>
<ul>
<li><p><code>predictor_data</code>: Grid cell data</p></li>
<li><p><code>scale_pred</code>, <code>shape_pred</code>: Predicted
parameters</p></li>
<li><p><code>country_code</code>: ISO3 country code</p></li>
<li><p><code>age_range</code>: Vector of min/max ages</p></li>
<li><p><code>age_interval</code>: Age grouping interval</p></li>
<li><p><code>ignore_cache</code>: Whether to use cached results</p></li>
<li><p><code>output_dir</code>: Output directory</p></li>
</ul>
<p>Produces two data frames:</p>
<ul>
<li><p><code>prop_df</code>: Age proportions with uncertainty</p></li>
<li><p><code>pop_df</code>: Population counts with uncertainty</p></li>
</ul>
</div>
<div class="section level4">
<h4 id="vii--generate_age_pyramid_plot">3vii. <code>generate_age_pyramid_plot()</code><a class="anchor" aria-label="anchor" href="#vii--generate_age_pyramid_plot"></a>
</h4>
<p>This function creates population pyramids (either counts or
proportions) for visualizing demographic structures across user-defined
geographic units.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/generate_age_pyramid_plot.html">generate_age_pyramid_plot</a></span><span class="op">(</span></span>
<span>  <span class="va">dataset</span>,</span>
<span>  <span class="va">country_code</span>,</span>
<span>  output_dir <span class="op">=</span> <span class="st">"03_outputs/3b_visualizations"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Parameters:</p>
<ul>
<li><p><code>dataset</code>: List containing prop_df and pop_df</p></li>
<li><p><code>country_code</code>: ISO3 country code</p></li>
<li><p><code>output_dir</code>: Output directory</p></li>
<li><p><code>fill_high</code>, <code>fill_low</code>: Color gradient
endpoints</p></li>
<li><p><code>line_color</code>: Bar outline color</p></li>
<li><p><code>break_axis_by</code>: Age axis interval</p></li>
</ul>
<p>Creates:</p>
<ul>
<li>A list containing both proportion and count plots.</li>
</ul>
</div>
<div class="section level4">
<h4 id="viii--process_final_population_data">3viii. <code>process_final_population_data()</code><a class="anchor" aria-label="anchor" href="#viii--process_final_population_data"></a>
</h4>
<p>This function summarizes final outputs into Excel or CSV files.
Allows users to retrieve final aggregated counts, proportions, and
uncertainties for reporting.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/process_final_population_data.html">process_final_population_data</a></span><span class="op">(</span></span>
<span>  input_dir <span class="op">=</span> <span class="st">"03_outputs/3c_table_outputs"</span>,</span>
<span>  excel_output_file <span class="op">=</span> <span class="st">"03_outputs/3d_compiled_results/age_pop_denom_compiled.xlsx"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Parameters: - <code>input_dir</code>: Directory containing results -
<code>excel_output_file</code>: Path for Excel outpu</p>
<p>Produces: - The function writes an Excel spreadhseet with six sheets
containing population counts and proportions at different administrative
levels (country, region, district).</p>
<p>By allowing you to pass parameters to the underlying functions,
<code><a href="../reference/run_full_workflow.html">run_full_workflow()</a></code> offers both flexibility and efficiency
in managing the geostatistical modeling process. Each sub-function
within the workflow accepts a variety of parameters, enabling advanced
users to tailor the workflow to their specific needs. These parameters
support customization of datasets, modeling approaches (including
initial model parameters and additional covariates), grid resolutions,
output formats, and caching options. This level of control ensures that
the workflow aligns with the specific analytical requirements of the
user.</p>
</div>
</div>
<div class="section level3">
<h3 id="example-gambia">Example: Gambia<a class="anchor" aria-label="anchor" href="#example-gambia"></a>
</h3>
<p>To demonstrate <strong>AgePopDenom</strong>, we provide an example
workflow using simulated DHS-like data for Gambia. This enables users to
replicate fine-scale age-structured population modeling locally without
requiring restricted data access. The example covers directory setup,
dummy data simulation, and running the full modeling workflow.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/init.html">init</a></span><span class="op">(</span></span>
<span>  r_script_name <span class="op">=</span> <span class="st">"full_pipeline.R"</span>,</span>
<span>  cpp_script_name <span class="op">=</span> <span class="st">"model.cpp"</span>,</span>
<span>  open_r_script <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># set up country code</span></span>
<span><span class="va">cntry_code</span> <span class="op">=</span> <span class="st">"GMB"</span></span>
<span></span>
<span><span class="co"># Gather and process datasets ---------------------------------------</span></span>
<span></span>
<span><span class="co"># Set parameters for simulation</span></span>
<span><span class="va">total_population</span> <span class="op">&lt;-</span> <span class="fl">266</span></span>
<span><span class="va">urban_proportion</span> <span class="op">&lt;-</span> <span class="fl">0.602</span></span>
<span><span class="va">total_coords</span> <span class="op">&lt;-</span> <span class="fl">266</span></span>
<span><span class="va">lon_range</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">16.802</span>, <span class="op">-</span><span class="fl">13.849</span><span class="op">)</span></span>
<span><span class="va">lat_range</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">13.149</span>, <span class="fl">13.801</span><span class="op">)</span></span>
<span><span class="va">mean_web_x</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">1764351</span></span>
<span><span class="va">mean_web_y</span> <span class="op">&lt;-</span> <span class="fl">1510868</span></span>
<span></span>
<span><span class="co"># Simulate processed survey dataset for Gambia</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">df_gambia</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="va">df_gambia</span><span class="op">$</span><span class="va">age_param_data</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  country <span class="op">=</span> <span class="st">"Gambia"</span>,</span>
<span>  country_code_iso3 <span class="op">=</span> <span class="st">"GMB"</span>,</span>
<span>  country_code_dhs <span class="op">=</span> <span class="st">"GM"</span>, </span>
<span>  year_of_survey <span class="op">=</span> <span class="fl">2024</span>,</span>
<span>  id_coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">total_coords</span>, length.out <span class="op">=</span> <span class="va">total_population</span><span class="op">)</span>,</span>
<span>  lon <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">total_population</span>, <span class="va">lon_range</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">lon_range</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>,</span>
<span>  lat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">total_population</span>, <span class="va">lat_range</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">lat_range</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>, </span>
<span>  web_x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">total_population</span>, <span class="va">mean_web_x</span>, <span class="fl">50000</span><span class="op">)</span>,</span>
<span>  web_y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">total_population</span>, <span class="va">mean_web_y</span>, <span class="fl">50000</span><span class="op">)</span>,</span>
<span>  log_scale <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">total_population</span>, <span class="fl">2.82</span>, <span class="fl">0.2</span><span class="op">)</span>,</span>
<span>  log_shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">total_population</span>, <span class="fl">0.331</span>, <span class="fl">0.1</span><span class="op">)</span>,</span>
<span>  urban <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_population</span> <span class="op">*</span> <span class="va">urban_proportion</span><span class="op">)</span>, </span>
<span>    <span class="va">total_population</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">total_population</span> <span class="op">*</span> <span class="va">urban_proportion</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  b1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">total_population</span>, <span class="fl">0.0142</span>, <span class="fl">0.002</span><span class="op">)</span>,</span>
<span>  c <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">total_population</span>, <span class="op">-</span><span class="fl">0.00997</span>, <span class="fl">0.001</span><span class="op">)</span>,</span>
<span>  b2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">total_population</span>, <span class="fl">0.00997</span>, <span class="fl">0.002</span><span class="op">)</span>,</span>
<span>  nsampled <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">180</span><span class="op">:</span><span class="fl">220</span>, <span class="va">total_population</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># save as processed dhs data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span></span>
<span>  <span class="va">df_gambia</span>,</span>
<span>  file <span class="op">=</span> <span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org/reference/here.html" class="external-link">here</a></span><span class="op">(</span></span>
<span>    <span class="st">"01_data"</span>, <span class="st">"1a_survey_data"</span>, <span class="st">"processed"</span>, </span>
<span>    <span class="st">"dhs_pr_records_combined.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Download shapefiles</span></span>
<span><span class="fu"><a href="../reference/download_shapefile.html">download_shapefile</a></span><span class="op">(</span><span class="va">cntry_code</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Download population rasters from worldpop</span></span>
<span><span class="fu"><a href="../reference/download_pop_rasters.html">download_pop_rasters</a></span><span class="op">(</span><span class="va">cntry_code</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Extract urban extent raster</span></span>
<span><span class="fu"><a href="../reference/extract_afurextent.html">extract_afurextent</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run models and get outputs ------------------------------------------</span></span>
<span></span>
<span><span class="co"># Run the full model workflow</span></span>
<span><span class="fu"><a href="../reference/run_full_workflow.html">run_full_workflow</a></span><span class="op">(</span><span class="va">cntry_code</span><span class="op">)</span></span></code></pre></div>
<p>For more detailed information on advanced usage (e.g., integrating
additional covariates, applying user-supplied rasters), consult the
function-specific help files. We hope this package empowers you to
reliably estimate age-structured population counts in diverse contexts
and at finer geographic scales than was previously feasible.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Mohamed A. Yusuf, Victor A. Alegana, Chris Nnanatu, Andrew Tatem.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
